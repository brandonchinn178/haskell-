%YAML 1.2
---
name: Haskell++
file_extensions: [hs]
scope: source.haskell

variables:
  # Identifiers and Operators
  # https://www.haskell.org/onlinereport/lexemes.html#sect2.4
  lower_ident: '[a-z][\w'']*'
  upper_ident: '[A-Z][\w'']*'
  operator: '(?!:)[!#$%&*+./<=>?@\^|-~:]+'

contexts:
  prototype:
    - include: comments

  main:
    - include: imports

  ### Identifiers ###

  module_name:
    - match: '({{upper_ident}}\.)*({{upper_ident}})'
      scope: entity.name.namespace.haskell

  ### Utilities ###

  pop_when_deindent:
    - match: '^(?!\1\s)'
      pop: true

  ### Comments ###

  comments:
    - include: pragmas
    - include: comments-line
    - include: comments-block

  comments-line:
    - match: --
      scope: punctuation.definition.comment
      push: comments-line-body

  comments-line-body:
    - meta_include_prototype: false
    - meta_scope: comment.line.haskell
    - match: \n
      pop: true

  pragmas:
    - match: '{-#'
      scope: punctuation.definition.comment
      push: pragmas-body

  pragmas-body:
    - meta_include_prototype: false
    - meta_scope: comment.block.pragma.haskell
    - match: '#-}'
      scope: punctuation.definition.comment
      pop: true
    - match: (?i)ANN
      scope: keyword.other.pragma.haskell
      push: pragmas-annotation
    - match: |-
        (?ix)
            LANGUAGE
          | OPTIONS_GHC
          | INCLUDE
          | WARNING
          | DEPRECATED
          | MINIMAL
          | INLINE
          | NOINLINE
          | INLINABLE
          | CONLIKE
          | LINE
          | COLUMN
          | RULES
          | SPECIALIZE
          | SPECIALICE
          | UNPACK
          | NOUNPACK
          | SOURCE
          | COMPLETE
          | OVERLAPPING
          | OVERLAPPABLE
          | OVERLAPS
          | INCOHERENT
      scope: keyword.other.pragma.haskell

  pragmas-annotation:
    - clear_scopes: true
    - meta_scope: meta.annotation.haskell
    - match: '(?=#-})'
      pop: true
    - match: \b(type|module)\b
      scope: keyword.other.annotation.haskell
    - include: expressions

  comments-block:
    - match: '{-'
      scope: punctuation.definition.comment
      push: comments-block-body

  comments-block-body:
    - meta_include_prototype: false
    - meta_scope: comment.block.haskell
    - match: '{-'
      push: comments-block-body
    - match: '-}'
      scope: punctuation.definition.comment
      pop: true

  ### Imports ###

  imports:
    - match: ^(\s*)(import)\b
      captures:
        2: keyword.control.import.haskell
      push: imports-line

  imports-line:
    - meta_scope: meta.import.haskell
    - include: pop_when_deindent
    - match: \b(qualified|as|hiding)\b
      scope: keyword.control.import.modifiers.haskell
    - include: module_name
    - match: \(
      scope: punctuation.section.parens.begin.haskell
      push: imports-list

  # import UnliftIO (UnliftIO, withRunInIO)
  #                  ^^^^^^^^^^^^^^^^^^^^^
  imports-list:
    - match: \)
      scope: punctuation.section.parens.end.haskell
      pop: true
    - match: \b(type) (\({{operator}}\))
      captures:
        1: keyword.other.import.haskell
        2: keyword.operator.type.haskell
    - match: \b(pattern) ({{upper_ident}})
      captures:
        1: keyword.other.import.haskell
        2: variable.function.pattern.haskell
    - # explicitly check for `(..)`
      match: |-
        (?x)
          (\()
          (\.\.)
          (\))
      scope: meta.import.type-members.haskell
      captures:
        1: punctuation.section.parens.begin.haskell
        2: keyword.operator.import.wildcard.haskell
        3: punctuation.section.parens.end.haskell
    - match: \({{operator}}\)
      scope: keyword.operator.haskell
    - match: \(
      scope: punctuation.section.parens.begin.haskell
      push: imports-list-type-members
    - match: '{{upper_ident}}'
      scope: storage.type.haskell
    - match: '{{lower_ident}}'
      scope: variable.function.haskell
    - match: ','
      scope: punctuation.separator.haskell

  # import GHC.Exts (IsList (Item, fromList))
  #                          ^^^^^^^^^^^^^^
  imports-list-type-members:
    - meta_scope: meta.import.type-members.haskell
    - match: \)
      scope: punctuation.section.parens.end.haskell
      pop: true
    - match: '{{upper_ident}}'
      scope: variable.function.constructor.haskell
    - match: '{{lower_ident}}'
      scope: variable.function.haskell
    - match: ','
      scope: punctuation.separator.haskell
    - match: \(:{{operator}}\)
      scope: keyword.operator.type.haskell
    - match: \({{operator}}\)
      scope: keyword.operator.haskell #variable.other.import.operator.haskell

  ### Expressions ###

  expressions:
    - match: '{{lower_ident}}'
      scope: variable.other.function.haskell
    - match: '{{upper_ident}}'
      scope: variable.other.type.haskell
    - match: '"'
      push: expressions-string-body

  expressions-string-body:
    - meta_include_prototype: false
    - meta_scope: string.quoted.double.haskell
    - match: '"'
      pop: true
